"""
analyze_chat.py - анализирует экспорт Telegram-чата по госзакупкам,
находит упоминаемые темы, НПА и проблемные вопросы.
"""
import json
import sys
import re
from collections import Counter

sys.stdout.reconfigure(encoding='utf-8')

CHAT_PATH = r'C:\Users\fazyl\Downloads\проект Госзакуп\result.json'

with open(CHAT_PATH, encoding='utf-8') as f:
    data = json.load(f)

msgs = data['messages']

# Извлекаем тексты
texts = []
for m in msgs:
    if m.get('type') != 'message':
        continue
    text = m.get('text', '')
    if isinstance(text, list):
        text = ''.join(p['text'] if isinstance(p, dict) else p for p in text)
    text = text.strip()
    if len(text) > 40:
        texts.append(text)

all_text = ' '.join(texts)
print(f'Сообщений для анализа: {len(texts)}')
print(f'Период: {msgs[0]["date"]} — {msgs[-1]["date"]}')
print()

# ── Темы / ключевые слова ──────────────────────────────────────────────────────
TOPICS = {
    'Местное содержание / КТП / ДВЦ': [
        'КТП', 'ДВЦ', 'местное содержание', 'товаропроизводител',
        'казахстанское содержание', 'реестр производител',
    ],
    'НДС / ставка': [
        'НДС', 'ставка ндс', 'счет-фактур', 'ЕСФ', '16%', '12%',
    ],
    'Обжалование / САК': [
        'обжалован', 'САК', 'жалоб', 'уполномоченный орган',
        'апелляц', 'протест',
    ],
    'Договор / допик / изменения': [
        'допик', 'дополнительное соглашение', 'изменени', 'договор',
        'расторжен', 'пролонгац',
    ],
    'Акт выполненных работ': [
        'акт', 'выполненных работ', 'приемка', 'сдача',
    ],
    'Обеспечение заявки / гарантия': [
        'обеспечение заявки', 'гарантия', 'залог', 'кошелек',
        'ЦЭФ', 'электронный кошелек',
    ],
    'Неустойка / штраф / пени': [
        'неустойк', 'пени', 'штраф', 'санкц',
    ],
    'Квалификация поставщика': [
        'квалификац', 'бенефициар', 'предквалификац',
        'реестр недобросовест', 'РНП',
    ],
    'Конкурс': [
        'конкурс', 'конкурсн', 'тендер',
    ],
    'Аукцион': [
        'аукцион', 'демпинг', 'стартовая цена',
    ],
    'Один источник': [
        'один источник', 'одного источника', 'прямой договор',
    ],
    'Электронный магазин': [
        'электронный магазин', 'эмагазин', 'магазин',
    ],
    'Запрос ценовых предложений': [
        'запрос цен', 'ЗЦП',
    ],
    'Планирование / план закупок': [
        'план закупок', 'годовой план', 'планирован',
    ],
    'Субподряд / консорциум': [
        'субподряд', 'консорциум', 'соисполнител',
    ],
    'Налоги / КГД / отображение': [
        'налог', 'КГД', 'задолженност', 'уплаченн',
    ],
    'Казначейство / оплата': [
        'казначейств', 'казна', 'оплат', 'платеж', 'финансирован',
    ],
    'МРП / тарифы': [
        'МРП', 'минимальн', 'тариф',
    ],
    'Сроки / дедлайн': [
        'срок', 'продление срок', 'дедлайн', 'истек',
    ],
    'Портал / технические проблемы': [
        'портал', 'веб-портал', 'не работает', 'техническ', 'ошибка',
    ],
}

print('=== ТОП ТЕМ (по упоминаниям) ===')
topic_counts = {}
for topic, keywords in TOPICS.items():
    count = 0
    for kw in keywords:
        count += all_text.lower().count(kw.lower())
    topic_counts[topic] = count

for topic, count in sorted(topic_counts.items(), key=lambda x: -x[1]):
    bar = '█' * min(count // 5, 40)
    print(f'  {count:4d}  {topic}')

print()

# ── Упоминания конкретных НПА ──────────────────────────────────────────────────
print('=== УПОМИНАНИЯ КОНКРЕТНЫХ НПА ===')
npa_re = re.compile(
    r'(?:'
    r'[Пп]риказ[а-яё]*\s+(?:МФ\s+РК|Министр[а-яё]*|№)\s*[\w\-–№]+|'
    r'[Пп]остановлени[а-яё]*\s+(?:Правительства|Правительство|№)\s*[\w\-–№]+|'
    r'Приказ\s+№\s*\d+|'
    r'[Зз]акон[а-яё]*\s+(?:РК\s+)?(?:о\s+государственных|от\s+\d)|'
    r'[Пп]равила\s+(?:формирован|осуществлен|ведения|определен)|'
    r'[Пп]риложени[еяю]\s+\d+|'
    r'Приказ\s+МФ|'
    r'№\s*6[0-9]{2}|№\s*7[0-9]{2}|№\s*8[0-9]{2}'
    r')'
)
npa_matches = npa_re.findall(all_text)
npa_counter = Counter(m.strip() for m in npa_matches)
for npa, cnt in npa_counter.most_common(20):
    print(f'  {cnt:3d}x  {npa}')

print()

# ── Проблемные вопросы (сообщения с вопросительным знаком) ────────────────────
print('=== ЧАСТЫЕ ВОПРОСЫ (примеры) ===')
questions = [t for t in texts if '?' in t and len(t) < 400]
# Группируем по темам
topic_questions = {t: [] for t in TOPICS}
for q in questions:
    for topic, keywords in TOPICS.items():
        if any(kw.lower() in q.lower() for kw in keywords):
            topic_questions[topic].append(q)
            break

for topic, qs in sorted(topic_questions.items(), key=lambda x: -len(x[1])):
    if qs:
        print(f'\n--- {topic} ({len(qs)} вопросов) ---')
        for q in qs[:2]:
            print(f'  > {q[:200]}')
