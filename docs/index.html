<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ĞĞ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ | Goszakup Bot</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f1117;
      color: #e2e8f0;
      min-height: 100vh;
    }

    /* â”€â”€ Ğ›Ğ¾Ğ³Ğ¸Ğ½ â”€â”€ */
    #login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .login-box {
      background: #1e2130;
      border: 1px solid #2d3252;
      border-radius: 12px;
      padding: 40px;
      width: 360px;
      text-align: center;
    }
    .login-box h1 { font-size: 22px; margin-bottom: 8px; color: #fff; }
    .login-box p  { color: #718096; font-size: 14px; margin-bottom: 28px; }
    .login-box input {
      width: 100%;
      padding: 12px 16px;
      background: #0f1117;
      border: 1px solid #2d3252;
      border-radius: 8px;
      color: #e2e8f0;
      font-size: 15px;
      margin-bottom: 14px;
    }
    .login-box input:focus { outline: none; border-color: #5b6af0; }
    .btn-primary {
      width: 100%;
      padding: 12px;
      background: #5b6af0;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s;
    }
    .btn-primary:hover { background: #4a58d8; }
    #login-error { color: #fc8181; font-size: 13px; margin-top: 10px; }

    /* â”€â”€ ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ â”€â”€ */
    #app { display: none; }

    header {
      background: #1e2130;
      border-bottom: 1px solid #2d3252;
      padding: 14px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 { font-size: 18px; font-weight: 700; color: #fff; }
    header .subtitle { font-size: 12px; color: #718096; margin-top: 2px; }
    .logout-btn {
      background: transparent;
      border: 1px solid #2d3252;
      border-radius: 6px;
      color: #718096;
      padding: 6px 14px;
      cursor: pointer;
      font-size: 13px;
      transition: all .2s;
    }
    .logout-btn:hover { border-color: #fc8181; color: #fc8181; }

    /* â”€â”€ ĞĞ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ â”€â”€ */
    nav {
      display: flex;
      gap: 4px;
      padding: 16px 28px 0;
      border-bottom: 1px solid #2d3252;
    }
    .tab-btn {
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: #718096;
      padding: 8px 18px 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all .2s;
    }
    .tab-btn:hover { color: #e2e8f0; }
    .tab-btn.active { color: #5b6af0; border-bottom-color: #5b6af0; }

    /* â”€â”€ ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ â”€â”€ */
    main { padding: 28px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* â”€â”€ ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ â”€â”€ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }
    .stat-card {
      background: #1e2130;
      border: 1px solid #2d3252;
      border-radius: 10px;
      padding: 20px;
    }
    .stat-card .label { font-size: 12px; color: #718096; margin-bottom: 8px; text-transform: uppercase; letter-spacing: .5px; }
    .stat-card .value { font-size: 32px; font-weight: 700; color: #fff; }
    .stat-card .sub   { font-size: 12px; color: #5b6af0; margin-top: 4px; }

    /* â”€â”€ Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ â”€â”€ */
    .section-title {
      font-size: 15px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .table-wrap {
      background: #1e2130;
      border: 1px solid #2d3252;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 28px;
    }
    table { width: 100%; border-collapse: collapse; }
    th {
      background: #161827;
      padding: 11px 16px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .5px;
      color: #718096;
    }
    td {
      padding: 11px 16px;
      font-size: 13px;
      border-top: 1px solid #2d3252;
      vertical-align: top;
    }
    tr:hover td { background: #252840; }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge-green { background: #1a4731; color: #68d391; }
    .badge-blue  { background: #1a2e5a; color: #63b3ed; }
    .badge-red   { background: #4a1942; color: #fc8181; }

    /* â”€â”€ ĞŸĞ¾Ğ¸ÑĞº Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ â”€â”€ */
    .toolbar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      align-items: center;
      flex-wrap: wrap;
    }
    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 9px 14px;
      background: #1e2130;
      border: 1px solid #2d3252;
      border-radius: 8px;
      color: #e2e8f0;
      font-size: 14px;
    }
    .search-input:focus { outline: none; border-color: #5b6af0; }
    .btn-sm {
      padding: 9px 16px;
      background: #1e2130;
      border: 1px solid #2d3252;
      border-radius: 8px;
      color: #e2e8f0;
      font-size: 13px;
      cursor: pointer;
      transition: all .2s;
      white-space: nowrap;
    }
    .btn-sm:hover { border-color: #5b6af0; color: #5b6af0; }
    .btn-sm.active-filter { border-color: #5b6af0; background: #1a2040; color: #5b6af0; }

    /* â”€â”€ Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ â”€â”€ */
    .dialog-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.6);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    .dialog-overlay.open { display: flex; }
    .dialog {
      background: #1e2130;
      border: 1px solid #2d3252;
      border-radius: 12px;
      width: 90%;
      max-width: 720px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
    }
    .dialog-header {
      padding: 18px 24px;
      border-bottom: 1px solid #2d3252;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .dialog-header h2 { font-size: 16px; color: #fff; }
    .dialog-close {
      background: transparent;
      border: none;
      color: #718096;
      font-size: 22px;
      cursor: pointer;
      line-height: 1;
    }
    .dialog-close:hover { color: #fc8181; }
    .dialog-body {
      padding: 20px 24px;
      overflow-y: auto;
      flex: 1;
    }

    /* â”€â”€ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° â”€â”€ */
    .msg-pair { margin-bottom: 20px; }
    .msg-time { font-size: 11px; color: #4a5568; margin-bottom: 6px; }
    .msg-q, .msg-a {
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.6;
      margin-bottom: 6px;
      word-break: break-word;
    }
    .msg-q { background: #252840; border-left: 3px solid #5b6af0; }
    .msg-a { background: #1a2e1a; border-left: 3px solid #48bb78; font-size: 12.5px; color: #cbd5e0; }
    .msg-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 3px; }
    .msg-label.user { color: #5b6af0; }
    .msg-label.bot  { color: #48bb78; }
    .meta-chips { display: flex; gap: 6px; margin-top: 4px; }

    /* â”€â”€ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° â”€â”€ */
    .loading { text-align: center; padding: 40px; color: #718096; font-size: 14px; }
    .empty   { text-align: center; padding: 40px; color: #4a5568; font-size: 14px; }

    /* â”€â”€ ĞŸĞ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ â”€â”€ */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding-top: 8px;
    }
    .page-btn {
      padding: 6px 12px;
      background: #1e2130;
      border: 1px solid #2d3252;
      border-radius: 6px;
      color: #e2e8f0;
      font-size: 13px;
      cursor: pointer;
    }
    .page-btn:hover { border-color: #5b6af0; }
    .page-btn.current { background: #5b6af0; border-color: #5b6af0; color: #fff; }
    .page-btn:disabled { opacity: .4; cursor: default; }

    /* â”€â”€ Feedback â”€â”€ */
    .feedback-table .like   { color: #68d391; }
    .feedback-table .dislike { color: #fc8181; }

    /* â”€â”€ Ban/Unban ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ â”€â”€ */
    .btn-ban {
      padding: 5px 12px;
      background: transparent;
      border: 1px solid #742a2a;
      border-radius: 6px;
      color: #fc8181;
      font-size: 12px;
      cursor: pointer;
      transition: all .2s;
      white-space: nowrap;
    }
    .btn-ban:hover { background: #742a2a; }
    .btn-unban {
      padding: 5px 12px;
      background: transparent;
      border: 1px solid #276749;
      border-radius: 6px;
      color: #68d391;
      font-size: 12px;
      cursor: pointer;
      transition: all .2s;
      white-space: nowrap;
    }
    .btn-unban:hover { background: #276749; }
    .badge-banned { background: #742a2a; color: #fc8181; }
    .badge-active { background: #1a4731; color: #68d391; }
    .action-cell { display: flex; gap: 6px; align-items: center; flex-wrap: nowrap; }

    /* â”€â”€ Toast-ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ â”€â”€ */
    #toast {
      position: fixed;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: #2d3252;
      border: 1px solid #5b6af0;
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 14px;
      color: #e2e8f0;
      z-index: 999;
      transition: transform .3s ease;
      white-space: nowrap;
    }
    #toast.show { transform: translateX(-50%) translateY(0); }
    #toast.error { border-color: #fc8181; background: #4a1942; }
  </style>
</head>
<body>

<!-- â•â•â• Ğ­ĞšĞ ĞĞ Ğ’Ğ¥ĞĞ”Ğ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-screen">
  <div class="login-box">
    <h1>ğŸ›¡ï¸ Goszakup Bot</h1>
    <p>ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ</p>
    <input type="password" id="pwd-input" placeholder="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ" />
    <button class="btn-primary" onclick="doLogin()">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</button>
    <div id="login-error"></div>
  </div>
</div>

<!-- â•â•â• ĞĞ¡ĞĞĞ’ĞĞĞ™ Ğ˜ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">

  <header>
    <div>
      <h1>ğŸ“Š Goszakup Bot â€” ĞŸĞ°Ğ½ĞµĞ»ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°</h1>
      <div class="subtitle">Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¸ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞºĞ¸</div>
    </div>
    <button class="logout-btn" onclick="doLogout()">Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</button>
  </header>

  <nav>
    <button class="tab-btn active" onclick="switchTab('overview')">ğŸ“ˆ ĞĞ±Ğ·Ğ¾Ñ€</button>
    <button class="tab-btn" onclick="switchTab('users')">ğŸ‘¥ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸</button>
    <button class="tab-btn" onclick="switchTab('conversations')">ğŸ’¬ ĞŸĞµÑ€ĞµĞ¿Ğ¸ÑĞºĞ°</button>
    <button class="tab-btn" onclick="switchTab('feedback')">â­ ĞÑ‚Ğ·Ñ‹Ğ²Ñ‹</button>
  </nav>

  <main>

    <!-- â”€â”€ ĞĞ‘Ğ—ĞĞ  â”€â”€ -->
    <div id="tab-overview" class="tab-content active">
      <div class="stats-grid" id="stats-cards">
        <div class="stat-card"><div class="label">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div><div class="value">â€”</div></div>
      </div>

      <div class="section-title">ğŸ• ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ</div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Ğ’Ñ€ĞµĞ¼Ñ</th><th>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</th><th>Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ</th><th>Ğ§Ğ°Ğ½ĞºĞ¾Ğ²</th><th>ĞšĞ¢Ğ Ğ£</th>
          </tr></thead>
          <tbody id="recent-body"><tr><td colspan="5" class="loading">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ˜ â”€â”€ -->
    <div id="tab-users" class="tab-content">
      <div class="toolbar">
        <input class="search-input" id="user-search" placeholder="ğŸ” ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ¸Ğ»Ğ¸ @username..." oninput="filterUsers()"/>
        <button class="btn-sm" onclick="loadUsers()">â†» ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</th><th>Chat ID</th><th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</th><th>Ğ¯Ğ·Ñ‹Ğº</th><th>Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹</th><th>ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ²Ğ¸Ğ·Ğ¸Ñ‚</th><th>ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ²Ğ¸Ğ·Ğ¸Ñ‚</th><th>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</th>
          </tr></thead>
          <tbody id="users-body"><tr><td colspan="8" class="loading">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</td></tr></tbody>
        </table>
      </div>
      <div class="pagination" id="users-pagination"></div>
    </div>

    <!-- â”€â”€ ĞŸĞ•Ğ Ğ•ĞŸĞ˜Ğ¡ĞšĞ â”€â”€ -->
    <div id="tab-conversations" class="tab-content">
      <div class="toolbar">
        <input class="search-input" id="conv-search" placeholder="ğŸ” ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ñ‚ĞµĞºÑÑ‚Ñƒ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ°..."/>
        <button class="btn-sm" id="filter-ktru" onclick="toggleKtruFilter()">ĞšĞ¢Ğ Ğ£ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾</button>
        <button class="btn-sm" onclick="applyConvFilter()">ĞĞ°Ğ¹Ñ‚Ğ¸</button>
        <button class="btn-sm" onclick="resetConvFilter()">Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Ğ’Ñ€ĞµĞ¼Ñ</th><th>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</th><th>Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ</th><th>Ğ§Ğ°Ğ½ĞºĞ¾Ğ²</th><th>ĞšĞ¢Ğ Ğ£</th><th></th>
          </tr></thead>
          <tbody id="conv-body"><tr><td colspan="6" class="loading">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</td></tr></tbody>
        </table>
      </div>
      <div class="pagination" id="conv-pagination"></div>
    </div>

    <!-- â”€â”€ ĞĞ¢Ğ—Ğ«Ğ’Ğ« â”€â”€ -->
    <div id="tab-feedback" class="tab-content">
      <div class="toolbar">
        <button class="btn-sm active-filter" id="fb-all"    onclick="setFbFilter('all')">Ğ’ÑĞµ</button>
        <button class="btn-sm" id="fb-like"   onclick="setFbFilter('like')">ğŸ‘ ĞŸĞ¾Ğ»ĞµĞ·Ğ½Ğ¾</button>
        <button class="btn-sm" id="fb-dislike" onclick="setFbFilter('dislike')">ğŸ‘ ĞĞµ Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½Ğ¾</button>
        <button class="btn-sm" onclick="loadFeedback()">â†» ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ</button>
      </div>
      <div class="table-wrap feedback-table">
        <table>
          <thead><tr>
            <th>Ğ’Ñ€ĞµĞ¼Ñ</th><th>ĞÑ†ĞµĞ½ĞºĞ°</th><th>Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ</th><th>ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹</th>
          </tr></thead>
          <tbody id="feedback-body"><tr><td colspan="4" class="loading">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</td></tr></tbody>
        </table>
      </div>
      <div class="pagination" id="fb-pagination"></div>
    </div>

  </main>
</div>

<!-- â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="toast"></div>

<!-- â•â•â• Ğ”Ğ˜ĞĞ›ĞĞ“ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¯ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="dialog-overlay" id="dialog-overlay" onclick="closeDialog(event)">
  <div class="dialog">
    <div class="dialog-header">
      <h2 id="dialog-title">Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°</h2>
      <button class="dialog-close" onclick="closeDialogBtn()">Ã—</button>
    </div>
    <div class="dialog-body" id="dialog-body"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯ â€” Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = 'https://eozhplrnhhzszltwxhpb.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvemhwbHJuaGh6c3psdHd4aHBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Njg3MTIsImV4cCI6MjA4NzE0NDcxMn0.bqSKyIDMiucvRgvScVxFoljrDbmzN0wTfDIR1iGS0eU';

// ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ»Ñ Ğ²Ñ…Ğ¾Ğ´Ğ° (Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑÑ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ)
const ADMIN_PASSWORD = 'Goszakup2025!';

const PAGE_SIZE = 25;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let allUsers = [];
let convPage = 0, convKtruOnly = false, convSearch = '';
let fbFilter = 'all', fbPage = 0;
let usersPage = 0;

// â”€â”€ ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doLogin() {
  const pwd = document.getElementById('pwd-input').value;
  if (pwd === ADMIN_PASSWORD) {
    localStorage.setItem('admin_auth', '1');
    showApp();
  } else {
    document.getElementById('login-error').textContent = 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ';
  }
}
document.getElementById('pwd-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') doLogin();
});
function doLogout() {
  localStorage.removeItem('admin_auth');
  location.reload();
}
function showApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  loadOverview();
}
if (localStorage.getItem('admin_auth') === '1') showApp();

// â”€â”€ ĞĞ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  const tabs = ['overview','users','conversations','feedback'];
  document.querySelectorAll('.tab-btn')[tabs.indexOf(name)].classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
  if (name === 'overview')       loadOverview();
  if (name === 'users')          loadUsers();
  if (name === 'conversations')  { convPage=0; loadConversations(); }
  if (name === 'feedback')       { fbPage=0; loadFeedback(); }
}

// â”€â”€ Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtDate(d) {
  if (!d) return 'â€”';
  return new Date(d).toLocaleString('ru-RU', {
    day:'2-digit', month:'2-digit', year:'2-digit',
    hour:'2-digit', minute:'2-digit'
  });
}
function truncate(str, n) {
  if (!str) return '';
  return str.length > n ? str.slice(0, n) + 'â€¦' : str;
}
function userName(u) {
  let name = [u.first_name, u.last_name].filter(Boolean).join(' ') || 'â€”';
  if (u.username) name += ` <span style="color:#718096">@${u.username}</span>`;
  return name;
}

// â”€â”€ ĞĞ‘Ğ—ĞĞ  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadOverview() {
  // Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°
  const [
    { count: totalUsers },
    { count: totalMsgs },
    { count: todayMsgs },
    { count: totalFb },
  ] = await Promise.all([
    sb.from('users').select('*', { count: 'exact', head: true }),
    sb.from('conversations').select('*', { count: 'exact', head: true }),
    sb.from('conversations').select('*', { count: 'exact', head: true })
      .gte('created_at', new Date(Date.now() - 86400000).toISOString()),
    sb.from('feedback').select('*', { count: 'exact', head: true }),
  ]);

  const { count: likeCount } = await sb.from('feedback')
    .select('*', { count: 'exact', head: true }).eq('rating', 'like');

  document.getElementById('stats-cards').innerHTML = `
    <div class="stat-card">
      <div class="label">ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</div>
      <div class="value">${totalUsers ?? 0}</div>
      <div class="sub">Ğ²ÑĞµĞ³Ğ¾ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾</div>
    </div>
    <div class="stat-card">
      <div class="label">Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹</div>
      <div class="value">${totalMsgs ?? 0}</div>
      <div class="sub">Ğ²ÑĞµĞ³Ğ¾ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²</div>
    </div>
    <div class="stat-card">
      <div class="label">Ğ—Ğ° 24 Ñ‡Ğ°ÑĞ°</div>
      <div class="value">${todayMsgs ?? 0}</div>
      <div class="sub">Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ</div>
    </div>
    <div class="stat-card">
      <div class="label">ĞÑ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²</div>
      <div class="value">${totalFb ?? 0}</div>
      <div class="sub">ğŸ‘ ${likeCount ?? 0} Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½Ñ‹Ñ…</div>
    </div>
  `;

  // ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
  const { data: recent } = await sb.from('conversations')
    .select('*, users(first_name, last_name, username)')
    .order('created_at', { ascending: false })
    .limit(15);

  const tbody = document.getElementById('recent-body');
  if (!recent?.length) {
    tbody.innerHTML = '<tr><td colspan="5" class="empty">ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…</td></tr>';
    return;
  }
  tbody.innerHTML = recent.map(r => `
    <tr>
      <td style="white-space:nowrap;color:#718096">${fmtDate(r.created_at)}</td>
      <td>${r.users ? userName(r.users) : r.chat_id}</td>
      <td>${truncate(r.question, 80)}</td>
      <td style="text-align:center"><span class="badge badge-blue">${r.chunks_used}</span></td>
      <td style="text-align:center">${r.ktru_found ? '<span class="badge badge-green">âœ“</span>' : ''}</td>
    </tr>
  `).join('');
}

// â”€â”€ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUsers() {
  document.getElementById('users-body').innerHTML =
    '<tr><td colspan="7" class="loading">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</td></tr>';
  const { data } = await sb.from('users')
    .select('*')
    .order('last_seen', { ascending: false });
  allUsers = data || [];
  renderUsers();
}

function filterUsers() { usersPage = 0; renderUsers(); }

function renderUsers() {
  const q = document.getElementById('user-search').value.toLowerCase();
  const filtered = allUsers.filter(u =>
    (u.first_name||'').toLowerCase().includes(q) ||
    (u.last_name||'').toLowerCase().includes(q) ||
    (u.username||'').toLowerCase().includes(q) ||
    String(u.chat_id).includes(q)
  );
  const start = usersPage * PAGE_SIZE;
  const page  = filtered.slice(start, start + PAGE_SIZE);
  const tbody = document.getElementById('users-body');
  if (!page.length) {
    tbody.innerHTML = '<tr><td colspan="8" class="empty">ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹</td></tr>';
    document.getElementById('users-pagination').innerHTML = '';
    return;
  }
  tbody.innerHTML = page.map(u => {
    const banned = !!u.is_banned;
    const statusBadge = banned
      ? '<span class="badge badge-banned">â›” Ğ—Ğ°Ğ±Ğ°Ğ½ĞµĞ½</span>'
      : '<span class="badge badge-active">âœ… ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½</span>';
    const banBtn = banned
      ? `<button class="btn-unban" onclick="toggleBan(${u.chat_id}, false)">âœ… Ğ Ğ°Ğ·Ğ±Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>`
      : `<button class="btn-ban"   onclick="toggleBan(${u.chat_id}, true)">â›” Ğ—Ğ°Ğ±Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>`;
    const safeName = (u.first_name||'').replace(/'/g,"\\'");
    return `
    <tr id="user-row-${u.chat_id}">
      <td>${userName(u)}</td>
      <td style="color:#718096;font-size:12px">${u.chat_id}</td>
      <td>${statusBadge}</td>
      <td>${u.language_code || 'â€”'}</td>
      <td style="text-align:center"><span class="badge badge-blue">${u.message_count}</span></td>
      <td style="color:#718096;font-size:12px">${fmtDate(u.first_seen)}</td>
      <td style="color:#718096;font-size:12px">${fmtDate(u.last_seen)}</td>
      <td>
        <div class="action-cell">
          <button class="btn-sm" onclick="openUserHistory(${u.chat_id}, '${safeName}')">ğŸ’¬ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</button>
          ${banBtn}
        </div>
      </td>
    </tr>`;
  }).join('');
  renderPagination('users-pagination', usersPage, Math.ceil(filtered.length / PAGE_SIZE), p => { usersPage = p; renderUsers(); });
}

// â”€â”€ ĞŸĞ•Ğ Ğ•ĞŸĞ˜Ğ¡ĞšĞ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadConversations() {
  document.getElementById('conv-body').innerHTML =
    '<tr><td colspan="6" class="loading">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</td></tr>';

  let q = sb.from('conversations')
    .select('*, users(first_name, last_name, username)', { count: 'exact' })
    .order('created_at', { ascending: false })
    .range(convPage * PAGE_SIZE, (convPage + 1) * PAGE_SIZE - 1);

  if (convKtruOnly) q = q.eq('ktru_found', true);
  if (convSearch)   q = q.ilike('question', `%${convSearch}%`);

  const { data, count } = await q;
  const tbody = document.getElementById('conv-body');
  if (!data?.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="empty">ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾</td></tr>';
    document.getElementById('conv-pagination').innerHTML = '';
    return;
  }
  tbody.innerHTML = data.map(r => `
    <tr>
      <td style="white-space:nowrap;color:#718096;font-size:12px">${fmtDate(r.created_at)}</td>
      <td>${r.users ? userName(r.users) : `<span style="color:#718096">${r.chat_id}</span>`}</td>
      <td>${truncate(r.question, 90)}</td>
      <td style="text-align:center"><span class="badge badge-blue">${r.chunks_used}</span></td>
      <td style="text-align:center">${r.ktru_found ? '<span class="badge badge-green">âœ“</span>' : ''}</td>
      <td>
        <button class="btn-sm" onclick="openConvDetail(${JSON.stringify(r).replace(/"/g,'&quot;')})">
          ğŸ‘ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ
        </button>
      </td>
    </tr>
  `).join('');
  renderPagination('conv-pagination', convPage, Math.ceil(count / PAGE_SIZE), p => { convPage = p; loadConversations(); });
}

function applyConvFilter() {
  convSearch = document.getElementById('conv-search').value.trim();
  convPage = 0;
  loadConversations();
}
function resetConvFilter() {
  document.getElementById('conv-search').value = '';
  convSearch = '';
  convKtruOnly = false;
  document.getElementById('filter-ktru').classList.remove('active-filter');
  convPage = 0;
  loadConversations();
}
function toggleKtruFilter() {
  convKtruOnly = !convKtruOnly;
  document.getElementById('filter-ktru').classList.toggle('active-filter', convKtruOnly);
  convPage = 0;
  loadConversations();
}

// â”€â”€ ĞĞ¢Ğ—Ğ«Ğ’Ğ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadFeedback() {
  document.getElementById('feedback-body').innerHTML =
    '<tr><td colspan="4" class="loading">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</td></tr>';
  let q = sb.from('feedback')
    .select('*', { count: 'exact' })
    .order('created_at', { ascending: false })
    .range(fbPage * PAGE_SIZE, (fbPage + 1) * PAGE_SIZE - 1);
  if (fbFilter !== 'all') q = q.eq('rating', fbFilter);
  const { data, count } = await q;
  const tbody = document.getElementById('feedback-body');
  if (!data?.length) {
    tbody.innerHTML = '<tr><td colspan="4" class="empty">ĞĞµÑ‚ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²</td></tr>';
    document.getElementById('fb-pagination').innerHTML = '';
    return;
  }
  tbody.innerHTML = data.map(r => `
    <tr>
      <td style="white-space:nowrap;color:#718096;font-size:12px">${fmtDate(r.created_at)}</td>
      <td style="text-align:center">
        ${r.rating === 'like'
          ? '<span class="like" style="font-size:18px">ğŸ‘</span>'
          : '<span class="dislike" style="font-size:18px">ğŸ‘</span>'}
      </td>
      <td>${truncate(r.question, 100)}</td>
      <td style="color:#a0aec0;font-size:12px">${r.comment || ''}</td>
    </tr>
  `).join('');
  renderPagination('fb-pagination', fbPage, Math.ceil(count / PAGE_SIZE), p => { fbPage = p; loadFeedback(); });
}

function setFbFilter(f) {
  fbFilter = f;
  fbPage = 0;
  ['all','like','dislike'].forEach(x => document.getElementById('fb-'+x).classList.remove('active-filter'));
  document.getElementById('fb-'+f).classList.add('active-filter');
  loadFeedback();
}

// â”€â”€ ĞŸĞ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPagination(containerId, current, total, onPage) {
  const el = document.getElementById(containerId);
  if (total <= 1) { el.innerHTML = ''; return; }
  let html = `<button class="page-btn" ${current===0?'disabled':''} onclick="(${onPage})(${current-1})">â† ĞĞ°Ğ·Ğ°Ğ´</button>`;
  const start = Math.max(0, current - 2);
  const end   = Math.min(total - 1, current + 2);
  for (let i = start; i <= end; i++) {
    html += `<button class="page-btn ${i===current?'current':''}" onclick="(${onPage})(${i})">${i+1}</button>`;
  }
  html += `<button class="page-btn" ${current===total-1?'disabled':''} onclick="(${onPage})(${current+1})">Ğ’Ğ¿ĞµÑ€Ñ‘Ğ´ â†’</button>`;
  el.innerHTML = html;
}

// â”€â”€ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openUserHistory(chatId, name) {
  document.getElementById('dialog-title').textContent = `ğŸ’¬ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ: ${name || chatId}`;
  document.getElementById('dialog-body').innerHTML = '<div class="loading">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>';
  document.getElementById('dialog-overlay').classList.add('open');

  const { data } = await sb.from('conversations')
    .select('*')
    .eq('chat_id', chatId)
    .order('created_at', { ascending: true })
    .limit(100);

  if (!data?.length) {
    document.getElementById('dialog-body').innerHTML = '<div class="empty">ĞĞµÑ‚ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸</div>';
    return;
  }
  document.getElementById('dialog-body').innerHTML = data.map(r => `
    <div class="msg-pair">
      <div class="msg-time">${fmtDate(r.created_at)}</div>
      <div class="msg-q">
        <div class="msg-label user">ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</div>
        ${escHtml(r.question)}
      </div>
      <div class="msg-a">
        <div class="msg-label bot">Ğ‘Ğ¾Ñ‚</div>
        ${escHtml(truncate(r.answer, 600))}
        <div class="meta-chips">
          <span class="badge badge-blue">Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²: ${r.chunks_used}</span>
          ${r.ktru_found ? '<span class="badge badge-green">ĞšĞ¢Ğ Ğ£</span>' : ''}
        </div>
      </div>
    </div>
  `).join('');
}

// â”€â”€ Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Q&A â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openConvDetail(r) {
  document.getElementById('dialog-title').textContent = `ğŸ’¬ ${fmtDate(r.created_at)} Â· chat ${r.chat_id}`;
  document.getElementById('dialog-body').innerHTML = `
    <div class="msg-pair">
      <div class="msg-q">
        <div class="msg-label user">Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ</div>
        ${escHtml(r.question)}
      </div>
      <div class="msg-a">
        <div class="msg-label bot">ĞÑ‚Ğ²ĞµÑ‚ Ğ±Ğ¾Ñ‚Ğ°</div>
        ${escHtml(r.answer)}
        <div class="meta-chips">
          <span class="badge badge-blue">Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²: ${r.chunks_used}</span>
          ${r.ktru_found ? '<span class="badge badge-green">ĞšĞ¢Ğ Ğ£ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½</span>' : ''}
        </div>
      </div>
    </div>
  `;
  document.getElementById('dialog-overlay').classList.add('open');
}

function closeDialog(e) {
  if (e.target === document.getElementById('dialog-overlay'))
    document.getElementById('dialog-overlay').classList.remove('open');
}
function closeDialogBtn() {
  document.getElementById('dialog-overlay').classList.remove('open');
}

function escHtml(str) {
  return String(str||'')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
    .replace(/\n/g,'<br>');
}

// Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ¿Ğ¾ Escape
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') document.getElementById('dialog-overlay').classList.remove('open');
});

// â”€â”€ Toast-ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _toastTimer = null;
function showToast(msg, isError = false) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = isError ? 'error show' : 'show';
  if (_toastTimer) clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => { el.className = isError ? 'error' : ''; }, 3000);
}

// â”€â”€ Ğ‘Ğ°Ğ½ / Ğ Ğ°Ğ·Ğ±Ğ°Ğ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleBan(chatId, ban) {
  const action = ban ? 'Ğ·Ğ°Ğ±Ğ°Ğ½Ğ¸Ñ‚ÑŒ' : 'Ñ€Ğ°Ğ·Ğ±Ğ°Ğ½Ğ¸Ñ‚ÑŒ';
  if (!confirm(`Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ${action} Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ${chatId}?`)) return;

  const { error } = await sb.from('users')
    .update({ is_banned: ban })
    .eq('chat_id', chatId);

  if (error) {
    console.error('toggleBan error:', error);
    showToast(`âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ${error.message}`, true);
    return;
  }

  // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ² allUsers
  const user = allUsers.find(u => u.chat_id === chatId);
  if (user) user.is_banned = ban;

  // ĞŸĞµÑ€ĞµÑ€Ğ¸ÑĞ¾Ğ²Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ (Ğ±ĞµĞ· Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸)
  renderUsers();

  showToast(ban
    ? `â›” ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ${chatId} Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½`
    : `âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ${chatId} Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½`
  );
}
</script>
</body>
</html>
