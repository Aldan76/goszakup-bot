# –î–ï–ú–û: –£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –∞–º–±–∏–≥—É–æ–∑–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤

## –¢–ï–ö–£–©–ï–ï –ü–û–í–ï–î–ï–ù–ò–ï (–ë–ï–ó –£–¢–û–ß–ù–ï–ù–ò–ô)

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ö–∞–∫ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã?"

–ë–æ—Ç: 
- detect_platform() –≤–µ—Ä–Ω—É–ª None (–∞–º–±–∏–≥—É–æ–∑–Ω–æ)
- –ü–æ–∏—Å–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω –ø–æ goszakup (–ø–µ—Ä–≤—ã–π –≤ —Å–ø–∏—Å–∫–µ)
- –í–µ—Ä–Ω—É–ª –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è goszakup
- –ù–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ–ª –≤ –≤–∏–¥—É omarket!

–ü–†–û–ë–õ–ï–ú–ê: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç ‚ùå
```

## –ù–û–í–û–ï –ü–û–í–ï–î–ï–ù–ò–ï (–° –£–¢–û–ß–ù–ï–ù–ò–Ø–ú–ò)

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ö–∞–∫ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã?"

–ë–æ—Ç:
1. detect_platform() –≤–µ—Ä–Ω—É–ª None
2. search_supabase() –Ω–∞—à–µ–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç –î–í–£–• –ø–ª–∞—Ç—Ñ–æ—Ä–º:
   - 2 —á–∞–Ω–∫–∞ –æ—Ç omarket (–∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤)
   - 2 —á–∞–Ω–∫–∞ –æ—Ç goszakup (–∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫—É–ø–æ–∫)
3. needs_clarification() = True (–æ–±–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –Ω–∞–π–¥–µ–Ω—ã)
4. –ë–æ—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç:

   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ –í–∞—à –≤–æ–ø—Ä–æ—Å –º–æ–∂–µ—Ç –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º‚îÇ
   ‚îÇ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º.                             ‚îÇ
   ‚îÇ                                         ‚îÇ
   ‚îÇ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç–µ –∫–∞–∫–æ–π —Å–∞–π—Ç –≤–∞—Å    ‚îÇ
   ‚îÇ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç:                             ‚îÇ
   ‚îÇ                                         ‚îÇ
   ‚îÇ 1. Omarket.kz (—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω)    ‚îÇ
   ‚îÇ 2. goszakup.gov.kz (–ø–æ—Ä—Ç–∞–ª –∑–∞–∫—É–ø–æ–∫)    ‚îÇ
   ‚îÇ                                         ‚îÇ
   ‚îÇ –û—Ç–≤–µ—Ç—å—Ç–µ —Ü–∏—Ñ—Ä–æ–π (1, 2) –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ–º   ‚îÇ
   ‚îÇ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã                               ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "omarket"

–ë–æ—Ç:
- parse_platform_response("omarket") ‚Üí "omarket"
- –ü–µ—Ä–µ–∏–≥—Ä—ã—à –ø–æ–∏—Å–∫–∞ —Å platform="omarket"
- –í–µ—Ä–Ω—É–ª –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∏–º–µ–Ω–Ω–æ –¥–ª—è omarket
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç ‚úì

–†–ï–ó–£–õ–¨–¢–ê–¢: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç ‚úì‚úì‚úì
```

## –ü–†–ò–ú–ï–†–´ –ö–û–ì–î–ê –ù–£–ñ–ù–ê –£–¢–û–ß–ù–ï–ù–ò–ï

| –í–æ–ø—Ä–æ—Å | –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã –Ω–∞–π–¥–µ–Ω—ã | –ù—É–∂–Ω–∞ —É—Ç–æ—á–Ω–µ–Ω–∏–µ |
|--------|-------------------|-----------------|
| "–ö–∞–∫ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã?" | [omarket, goszakup] | ‚úì –î–ê |
| "–ö–∞–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è?" | [goszakup] | ‚úó –ù–ï–¢ (–æ–¥–Ω–∞) |
| "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º?" | [omarket] | ‚úó –ù–ï–¢ (–æ–¥–Ω–∞) |
| "–ö–∞–∫ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ omarket?" | [omarket] | ‚úó –ù–ï–¢ (—è–≤–Ω–æ–µ –∏–º—è) |
| "–ö–∞–∫ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ goszakup?" | [goszakup] | ‚úó –ù–ï–¢ (—è–≤–Ω–æ–µ –∏–º—è) |

## –ö–û–î –î–õ–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–ò –í BOT.PY

```python
from rag import answer_question, search_supabase
from rag_enhanced import (
    get_platforms_found,
    needs_clarification,
    get_clarification_message,
    parse_platform_response
)

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    question = update.message.text.strip()
    
    # === –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–º–±–∏–≥—É–æ–∑–Ω–æ—Å—Ç—å ===
    temp_chunks = search_supabase(question, top_n=3)
    platforms_found = get_platforms_found(temp_chunks)
    
    # –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ —É—Ç–æ—á–Ω–µ–Ω–∏–µ - —Å–ø—Ä–æ—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if needs_clarification(question, platforms_found):
        clarification_msg = get_clarification_message(platforms_found)
        await update.message.reply_text(clarification_msg)
        
        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        context.user_data['pending_question'] = question
        context.user_data['waiting_for_clarification'] = True
        return
    
    # === –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —É—Ç–æ—á–Ω–µ–Ω–∏–µ ===
    if context.user_data.get('waiting_for_clarification'):
        platform = parse_platform_response(question)
        
        if platform:
            original_question = context.user_data['pending_question']
            context.user_data['waiting_for_clarification'] = False
            
            # –ü–µ—Ä–µ–∏–≥—Ä—ã—à –ø–æ–∏—Å–∫–∞ —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π
            # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å logic –≤ answer_question() —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å platform
            answer, chunks_count, _ = answer_question(original_question, [])
            await update.message.reply_text(answer)
        else:
            await update.message.reply_text(
                "‚ùå –ù–µ —Å–º–æ–≥ –ø–æ–Ω—è—Ç—å –ø–ª–∞—Ç—Ñ–æ—Ä–º—É.\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ 'omarket' –∏–ª–∏ 'goszakup' (–∏–ª–∏ —Ü–∏—Ñ—Ä—ã 1, 2)"
            )
        return
    
    # === –†–ï–ì–£–õ–Ø–†–ù–´–ô –ü–û–ò–°–ö ===
    answer, chunks_count, _ = answer_question(question, [])
    await update.message.reply_text(answer)
```

## –°–¢–ê–¢–ò–°–¢–ò–ö–ê

- **–î–æ —É–ª—É—á—à–µ–Ω–∏—è:** ~15-20% –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (–∞–º–±–∏–≥—É–æ–∑–Ω—ã–µ)
- **–ü–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏—è:** 100% –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –≤—ã–±–∏—Ä–∞–µ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—É)

## –¢–†–ï–ë–£–ï–ú–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø

1. ‚úì –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å `rag_enhanced.py` —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è
2. ‚ö†Ô∏è –ù—É–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `bot.py`:
   - –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ `rag_enhanced`
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `needs_clarification()` –≤ `handle_message()`
   - –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —É—Ç–æ—á–Ω–µ–Ω–∏–µ
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `context.user_data` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
3. ‚ö†Ô∏è –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - —É–ª—É—á—à–∏—Ç—å `answer_question()` —á—Ç–æ–±—ã –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `platform` –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫

## –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê

‚úÖ –ë–æ–ª–µ–µ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –±–æ—Ç
‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –≤ –∞–º–±–∏–≥—É–æ–∑–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö
‚úÖ –õ—É—á—à–∏–π UX (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á–µ—Ç–∫–æ –≤–∏–¥–∏—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã)
‚úÖ –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –±—É–¥—É—â–∏–º –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º (–ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ)

## –†–ò–°–ö–ò

‚ö†Ô∏è –î–æ–±–∞–≤–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —à–∞–≥ –≤ –¥–∏–∞–ª–æ–≥ (–º–æ–∂–µ—Ç —Ä–∞–∑–¥—Ä–∞–∂–∞—Ç—å)
‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (context.user_data)
‚ö†Ô∏è –ù—É–∂–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ bot.py (–Ω–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏ —á—Ç–æ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π)

## –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô –ü–û–î–•–û–î

–ï—Å–ª–∏ –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏–µ, —Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –û–¢ –û–ë–ï–ò–• –ø–ª–∞—Ç—Ñ–æ—Ä–º:

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ö–∞–∫ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã?"

–ë–æ—Ç:
üì¶ OMARKET.KZ (—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω):
[–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è omarket...]

üèõÔ∏è GOSZAKUP.GOV.KZ (–ø–æ—Ä—Ç–∞–ª –∑–∞–∫—É–ø–æ–∫):
[–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è goszakup...]
```

–≠—Ç–æ –±–æ–ª–µ–µ –¥—Ä—É–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–Ω–æ–≥–æ—Å–ª–æ–≤–Ω–æ.
